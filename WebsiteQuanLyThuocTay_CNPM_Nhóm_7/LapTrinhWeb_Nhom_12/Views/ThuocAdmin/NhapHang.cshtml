@model LapTrinhWeb_Nhom_12.Models.NhapLoViewModel

@{
    ViewBag.Title = "Nhập kho";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-warning"><i class="bi bi-box-seam"></i> Nhập lô hàng mới</h3>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Hủy bỏ
        </a>
    </div>

    @using (Html.BeginForm())
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.IdThuoc)
        @Html.HiddenFor(m => m.TenThuoc)
        @Html.HiddenFor(m => m.AnhThuoc)
        @Html.HiddenFor(m => m.DonViTinh)
        @Html.HiddenFor(m => m.GiaBanHienTai)
        @Html.HiddenFor(m => m.TongTonKho)

        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm border-warning">
                    <div class="card-header bg-warning text-dark fw-bold">
                        Sản phẩm nhập kho
                    </div>
                    <div class="card-body text-center">
                        <img src="@Url.Content("~/Images/AnhThuoc/" + (Model.AnhThuoc ?? "default.png"))"
                             class="img-fluid rounded mb-3 border p-1" style="max-height: 180px;">

                        <h5 class="fw-bold text-primary">@Model.TenThuoc</h5>
                        <p class="text-muted mb-3">ĐVT: @Model.DonViTinh</p>

                        <div class="row text-start border-top pt-3">
                            <div class="col-6">
                                <small class="text-muted d-block">Tồn kho hiện tại</small>
                                <span class="fw-bold fs-5">@Model.TongTonKho</span>
                            </div>
                            <div class="col-6 text-end">
                                <small class="text-muted d-block">Giá bán hiện tại</small>
                                <span class="fw-bold text-success fs-5">@Model.GiaBanHienTai.ToString("N0") đ</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 fw-bold">Thông tin lô hàng</h5>
                    </div>
                    <div class="card-body">
                        @Html.ValidationSummary(true, "", new { @class = "alert alert-danger" })

                        <div class="mb-3">
                            <label class="form-label fw-bold">Số lô (Batch No) <span class="text-danger">*</span></label>
                            @Html.EditorFor(model => model.SoLo, new { htmlAttributes = new { @class = "form-control form-control-lg text-uppercase", placeholder = "VD: A00123" } })
                            @Html.ValidationMessageFor(model => model.SoLo, "", new { @class = "text-danger" })
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Ngày sản xuất</label>
                                @Html.EditorFor(model => model.NgaySanXuat, new { htmlAttributes = new { @class = "form-control", type = "date" } })
                                @Html.ValidationMessageFor(model => model.NgaySanXuat, "", new { @class = "text-danger" })
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Hạn sử dụng</label>
                                @Html.EditorFor(model => model.HanSuDung, new { htmlAttributes = new { @class = "form-control", type = "date" } })
                                @Html.ValidationMessageFor(model => model.HanSuDung, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <hr />

                        <div class="row mb-4 bg-light p-3 rounded mx-0">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Số lượng nhập</label>
                                @Html.EditorFor(model => model.SoLuongNhap, new { htmlAttributes = new { @class = "form-control fw-bold text-primary", type = "number", min = "1", id = "SoLuong" } })
                                @Html.ValidationMessageFor(model => model.SoLuongNhap, "", new { @class = "text-danger" })
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Giá nhập (VNĐ)</label>
                                <div class="input-group">
                                    @Html.EditorFor(model => model.GiaNhap, new { htmlAttributes = new { @class = "form-control fw-bold", type = "number", min = "0", id = "GiaNhap" } })
                                    <span class="input-group-text">₫</span>
                                </div>
                                @Html.ValidationMessageFor(model => model.GiaNhap, "", new { @class = "text-danger" })
                            </div>

                            <div class="col-12 mt-3 text-end">
                                <span class="text-muted">Tổng giá trị lô hàng: </span>
                                <span class="fw-bold text-danger fs-4" id="ThanhTien">0</span> <span class="text-danger fw-bold">đ</span>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-warning w-100 py-2 fw-bold shadow-sm">
                                <i class="bi bi-save"></i> Lưu & Nhập kho
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Script tính tiền tự động khi nhập số lượng hoặc giá
        $(document).ready(function () {
            function calculateTotal() {
                var sl = parseInt($('#SoLuong').val()) || 0;
                var gia = parseInt($('#GiaNhap').val()) || 0;
                var total = sl * gia;
                // Format tiền tệ kiểu VN (1.000.000)
                $('#ThanhTien').text(total.toLocaleString('vi-VN'));

                // Cảnh báo nếu giá nhập cao hơn giá bán hiện tại
                var giaBanHienTai = @Model.GiaBanHienTai;
                if(gia > giaBanHienTai && giaBanHienTai > 0) {
                    $('#GiaNhap').addClass('is-invalid');
                    if($('#warning-price').length === 0) {
                        $('#GiaNhap').parent().after('<div id="warning-price" class="text-danger small mt-1"><i class="bi bi-exclamation-triangle"></i> Giá nhập đang cao hơn giá bán!</div>');
                    }
                } else {
                    $('#GiaNhap').removeClass('is-invalid');
                    $('#warning-price').remove();
                }
            }

            $('#SoLuong, #GiaNhap').on('input', calculateTotal);
            calculateTotal(); // Chạy 1 lần đầu
        });
    </script>
}